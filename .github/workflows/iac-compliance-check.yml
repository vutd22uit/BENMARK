name: IaC Compliance Check (CIS Benchmark)

on:
  pull_request:
    paths:
      - 'iac/**'
      - 'policies/**'
  push:
    branches:
      - main
    paths:
      - 'iac/**'
      - 'policies/**'
  workflow_dispatch:

jobs:
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        run: terraform fmt -check -recursive iac/aws
        continue-on-error: true

      - name: Terraform Init
        run: |
          cd iac/aws
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd iac/aws
          terraform validate

  checkov-scan:
    name: Checkov CIS Compliance Scan
    runs-on: ubuntu-latest
    needs: terraform-validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov
        id: checkov
        run: |
          checkov \
            --config-file policies/checkov/.checkov.yaml \
            --directory iac/aws \
            --output cli \
            --output json \
            --output-file-path . \
            --soft-fail
        continue-on-error: true

      - name: Upload Checkov Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkov-results
          path: results_*.json

      - name: Comment PR with Checkov Results
        if: github.event_name == 'pull_request' && steps.checkov.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('results_json.json', 'utf8'));
            
            let comment = '## üîí CIS Benchmark Compliance Check Results\n\n';
            comment += `**Status:** ‚ùå Failed\n\n`;
            comment += `**Summary:**\n`;
            comment += `- ‚úÖ Passed: ${results.summary.passed}\n`;
            comment += `- ‚ùå Failed: ${results.summary.failed}\n`;
            comment += `- ‚ö†Ô∏è Skipped: ${results.summary.skipped}\n\n`;
            
            if (results.results.failed_checks.length > 0) {
              comment += '### Failed Checks:\n\n';
              results.results.failed_checks.slice(0, 5).forEach(check => {
                comment += `- **${check.check_id}**: ${check.check_name}\n`;
                comment += `  - File: \`${check.file_path}\`\n`;
                comment += `  - Severity: ${check.severity}\n\n`;
              });
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  opa-conftest:
    name: OPA Policy Validation
    runs-on: ubuntu-latest
    needs: terraform-validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Generate Terraform Plan
        run: |
          cd iac/aws
          terraform init -backend=false
          terraform plan -out=tfplan.binary
          terraform show -json tfplan.binary > tfplan.json

      - name: Install Conftest
        run: |
          wget https://github.com/open-policy-agent/conftest/releases/download/v0.49.1/conftest_0.49.1_Linux_x86_64.tar.gz
          tar xzf conftest_0.49.1_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/

      - name: Run OPA Conftest
        run: |
          conftest test iac/aws/tfplan.json \
            --policy policies/opa \
            --namespace terraform \
            --output table

      - name: Fail on Policy Violations
        if: failure()
        run: |
          echo "‚ùå OPA policy violations detected!"
          echo "Please fix the violations before merging."
          exit 1

  compliance-gate:
    name: Compliance Gate
    runs-on: ubuntu-latest
    needs: [checkov-scan, opa-conftest]
    if: always()
    
    steps:
      - name: Check Compliance Status
        run: |
          if [ "${{ needs.checkov-scan.result }}" == "failure" ] || [ "${{ needs.opa-conftest.result }}" == "failure" ]; then
            echo "‚ùå Compliance checks failed. Blocking merge."
            exit 1
          else
            echo "‚úÖ All compliance checks passed!"
          fi
