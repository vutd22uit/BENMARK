name: Runtime Compliance Scan (CIS Benchmark)

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to scan'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

jobs:
  inspec-aws-scan:
    name: InSpec AWS CIS Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install InSpec
        run: gem install inspec-bin

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Run InSpec AWS CIS Benchmark
        run: |
          mkdir -p reports
          inspec exec policies/inspec/aws-cis-benchmark \
            -t aws:// \
            --reporter cli json:reports/aws-cis-report.json html:reports/aws-cis-report.html \
            --chef-license accept
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate Compliance Report
        run: |
          python scripts/generate_compliance_report.py \
            reports/aws-cis-report.json \
            reports

      - name: Upload Compliance Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compliance-reports
          path: |
            reports/*.json
            reports/*.html
            reports/*.md

      - name: Read Compliance Score
        id: compliance
        run: |
          SCORE=$(jq -r '.compliance_score' reports/compliance_summary.json)
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "Compliance Score: $SCORE%"

      - name: Comment on Commit with Results
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('reports/compliance_summary.json', 'utf8'));
            
            let status_emoji = 'ðŸ”´';
            let status_text = 'NON-COMPLIANT';
            if (summary.compliance_score >= 90) {
              status_emoji = 'ðŸŸ¢';
              status_text = 'COMPLIANT';
            } else if (summary.compliance_score >= 70) {
              status_emoji = 'ðŸŸ¡';
              status_text = 'PARTIALLY COMPLIANT';
            }
            
            const comment = `## ${status_emoji} CIS Benchmark Compliance Scan Results
            
            **Status:** ${status_text}  
            **Compliance Score:** ${summary.compliance_score}%
            
            | Metric | Count |
            |--------|-------|
            | Total Controls | ${summary.total_controls} |
            | âœ… Passed | ${summary.passed} |
            | âŒ Failed | ${summary.failed} |
            | âš ï¸ Skipped | ${summary.skipped} |
            
            ${summary.failed > 0 ? '### Failed Controls:\n' + summary.failed_control_ids.map(id => `- ${id}`).join('\n') : ''}
            
            ðŸ“Š [View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: comment
            });

      - name: Fail if compliance below threshold
        if: steps.compliance.outputs.score < 70
        run: |
          echo "âŒ Compliance score (${{ steps.compliance.outputs.score }}%) is below threshold (70%)"
          exit 1

  cloud-custodian-remediation:
    name: Cloud Custodian Auto-Remediation
    runs-on: ubuntu-latest
    needs: inspec-aws-scan
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Cloud Custodian
        run: pip install c7n

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Run Cloud Custodian (Dry-Run)
        run: |
          mkdir -p reports/custodian
          ./scripts/run_custodian.sh
        continue-on-error: true

      - name: Upload Custodian Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: custodian-reports
          path: reports/custodian/
